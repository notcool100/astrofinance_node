trigger:
  branches:
    include:
      - develop
  paths:
    include:
      - fe/*
      - be/*

pool:
  name: 'Astro'

variables:
  nodeVersion: '24.x'

stages:
- stage: BuildFrontend 
  displayName: 'Build Frontend'
  jobs:
  - job: BuildFrontendJob
    displayName: 'Build Next.js App'
    steps:
    - task: NodeTool@0
      inputs:
        versionSpec: '$(nodeVersion)'
      displayName: 'Install Node.js'
    
    - script: |
        cd fe
        npm install --legacy-peer-deps
        
        # Ensure environment files are properly set up
        echo "Setting up environment files for build"
        cp .env.production .env.local
      displayName: 'Install Frontend Dependencies'
    
    - script: |
        cd fe
        echo "Running TypeScript check with skipLibCheck flag"
        npm run type-check || true
      displayName: 'Run TypeScript Check (Non-blocking)'
    
    - script: |
        cd fe
        echo "Building frontend application with TypeScript errors ignored"
        NODE_OPTIONS=--max_old_space_size=4096 npm run build
      displayName: 'Build Frontend Application'
    
    - task: ArchiveFiles@2
      inputs:
        rootFolderOrFile: 'fe'
        includeRootFolder: false
        archiveType: 'tar'
        tarCompression: 'gz'
        archiveFile: '$(Build.ArtifactStagingDirectory)/frontend.tar.gz'
        replaceExistingArchive: true
    
    - task: PublishBuildArtifacts@1
      inputs:
        PathtoPublish: '$(Build.ArtifactStagingDirectory)/frontend.tar.gz'
        ArtifactName: 'frontend'
        publishLocation: 'Container'

- stage: BuildBackend
  displayName: 'Build Backend'
  jobs:
  - job: BuildBackendJob
    displayName: 'Build Node.js API'
    steps:
    - task: NodeTool@0
      inputs:
        versionSpec: '$(nodeVersion)'
      displayName: 'Install Node.js'
    
    - script: |
        cd be
        npm install
      displayName: 'Install Backend Dependencies'

    - script: |
        cd be
        npm run prisma:generate
      displayName: 'Generate Prisma Client'
    
    - script: |
        cd be
        npm run build
      displayName: 'Build Backend Application'
    
    - task: ArchiveFiles@2
      inputs:
        rootFolderOrFile: 'be'
        includeRootFolder: false
        archiveType: 'tar'
        tarCompression: 'gz'
        archiveFile: '$(Build.ArtifactStagingDirectory)/backend.tar.gz'
        replaceExistingArchive: true
    
    - task: PublishBuildArtifacts@1
      inputs:
        PathtoPublish: '$(Build.ArtifactStagingDirectory)/backend.tar.gz'
        ArtifactName: 'backend'
        publishLocation: 'Container'
- stage: DeployDev
  displayName: 'Deploy to Development'
  dependsOn: 
    - BuildFrontend
    - BuildBackend
  condition: and(succeeded('BuildFrontend'), succeeded('BuildBackend'), eq(variables['Build.SourceBranch'], 'refs/heads/develop'))
  jobs:
  - job: DeployFrontendDev
    displayName: 'Deploy Frontend to Dev'
    steps:
    - task: DownloadBuildArtifacts@1
      inputs:
        buildType: 'current'
        downloadType: 'single'
        artifactName: 'frontend'
        downloadPath: '$(System.ArtifactsDirectory)'
    
    - task: DownloadSecureFile@1
      name: frontendEnvDev
      displayName: 'Download Frontend .env File'
      inputs:
        secureFile: 'frontend-dev.env'

    - script: |
         echo "Listing downloaded files:"
         ls -la $(System.ArtifactsDirectory)
         
         # Create a clean temporary directory for extraction
         TEMP_DIR=$(mktemp -d)
         echo "Created temporary directory: $TEMP_DIR"
         
         # Extract to temporary directory first
         tar -xzf $(System.ArtifactsDirectory)/frontend/frontend.tar.gz -C $TEMP_DIR
         
         # Ensure target directory exists with proper permissions
         mkdir -p /var/www/astrofinance/frontend-dev
         
         # Remove existing .next directory if it exists to avoid permission issues
         if [ -d "/var/www/astrofinance/frontend-dev/.next" ]; then
           rm -rf /var/www/astrofinance/frontend-dev/.next
         fi
         
         # Copy files from temp directory to target directory
         rsync -av --exclude='.next/cache' $TEMP_DIR/ /var/www/astrofinance/frontend-dev/
         
         # Copy .env file from secure files
         echo "Copying .env file to frontend directory"
         cp $(frontendEnvDev.secureFilePath) /var/www/astrofinance/frontend-dev/.env.local
         chmod 600 /var/www/astrofinance/frontend-dev/.env.local
         
         # Clean up temporary directory
         rm -rf $TEMP_DIR
         
         echo "Frontend deployed to /var/www/astrofinance/frontend-dev"
      displayName: 'Extract Frontend Build'
    
    - script: |
        echo "Deploying nginx configuration for frontend on port 6000"
        
        # Copy nginx configuration from repository to nginx sites-available
        sudo cp $(Build.SourcesDirectory)/devops/infrastructure/nginx-frontend-dev.conf /etc/nginx/sites-available/astrofinance-frontend-dev
        
        # Create symlink to sites-enabled if it doesn't exist
        if [ ! -L "/etc/nginx/sites-enabled/astrofinance-frontend-dev" ]; then
          sudo ln -s /etc/nginx/sites-available/astrofinance-frontend-dev /etc/nginx/sites-enabled/astrofinance-frontend-dev
          echo "Created symlink for frontend nginx configuration"
        fi
        
        # Test nginx configuration
        sudo nginx -t
        
        # Reload nginx to apply changes
        sudo systemctl reload nginx
        
        echo "Frontend nginx configuration deployed and reloaded successfully"
      displayName: 'Deploy Frontend Nginx Configuration (Port 6000)'



  - job: DeployBackendDev
    displayName: 'Deploy Backend to Dev'
    steps:
    - task: DownloadBuildArtifacts@1
      inputs:
        buildType: 'current'
        downloadType: 'single'
        artifactName: 'backend'
        downloadPath: '$(System.ArtifactsDirectory)'
    
    - task: DownloadSecureFile@1
      name: backendEnvDev
      displayName: 'Download Backend .env File'
      inputs:
        secureFile: 'backend-dev.env'

    - script: |
        echo "Listing downloaded files:"
        ls -la $(System.ArtifactsDirectory)
        
        # Create a clean temporary directory for extraction
        TEMP_DIR=$(mktemp -d)
        echo "Created temporary directory: $TEMP_DIR"
        
        # Extract to temporary directory first
        tar -xzf $(System.ArtifactsDirectory)/backend/backend.tar.gz -C $TEMP_DIR
        
        # Ensure target directory exists with proper permissions
        mkdir -p /var/www/astrofinance/backend-dev
        
        # Copy files from temp directory to target directory
        rsync -av $TEMP_DIR/ /var/www/astrofinance/backend-dev/
        
        # Copy .env file from secure files
        echo "Copying .env file to backend directory"
        cp $(backendEnvDev.secureFilePath) /var/www/astrofinance/backend-dev/.env
        chmod 600 /var/www/astrofinance/backend-dev/.env
        
        # Clean up temporary directory
        rm -rf $TEMP_DIR
        
        echo "Backend deployed to /var/www/astrofinance/backend-dev"
      displayName: 'Extract Backend Build and Deploy .env'


    
    - script: |
        echo "Deploying nginx configuration for backend on port 6010"
        
        # Copy nginx configuration from repository to nginx sites-available
        sudo cp $(Build.SourcesDirectory)/devops/infrastructure/nginx-backend-dev.conf /etc/nginx/sites-available/astrofinance-backend-dev
        
        # Create symlink to sites-enabled if it doesn't exist
        if [ ! -L "/etc/nginx/sites-enabled/astrofinance-backend-dev" ]; then
          sudo ln -s /etc/nginx/sites-available/astrofinance-backend-dev /etc/nginx/sites-enabled/astrofinance-backend-dev
          echo "Created symlink for nginx configuration"
        fi
        
        # Test nginx configuration
        sudo nginx -t
        
        # Reload nginx to apply changes
        sudo systemctl reload nginx
        
        echo "Nginx configuration deployed and reloaded successfully"
      displayName: 'Deploy Backend Nginx Configuration (Port 6010)'
